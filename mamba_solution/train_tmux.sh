#!/bin/bash

# ะกะบัะธะฟั ะดะปั ะทะฐะฟััะบะฐ ะพะฑััะตะฝะธั ะฒ tmux ัะตััะธะธ
# ะะพะถะฝะพ ะฒัะนัะธ ะธะท ัะตัะผะธะฝะฐะปะฐ - ะพะฑััะตะฝะธะต ะฟัะพะดะพะปะถะธััั

SESSION_NAME="mamba_training"

# ะัะพะฒะตััะตะผ ัััะฐะฝะพะฒะปะตะฝ ะปะธ tmux
if ! command -v tmux &> /dev/null; then
    echo "โ ะะจะะะะ: tmux ะฝะต ัััะฐะฝะพะฒะปะตะฝ!"
    echo "ะฃััะฐะฝะพะฒะธัะต: sudo apt-get install tmux"
    exit 1
fi

# ะัะพะฒะตััะตะผ ัััะตััะฒัะตั ะปะธ ัะถะต ัะตััะธั
if tmux has-session -t $SESSION_NAME 2>/dev/null; then
    echo "โ๏ธ  ะกะตััะธั '$SESSION_NAME' ัะถะต ัััะตััะฒัะตั!"
    echo ""
    echo "ะัะฑะตัะธัะต ะดะตะนััะฒะธะต:"
    echo "  1) ะะพะดะบะปััะธัััั ะบ ัััะตััะฒัััะตะน ัะตััะธะธ"
    echo "  2) ะฃะดะฐะปะธัั ััะฐััั ะธ ัะพะทะดะฐัั ะฝะพะฒัั"
    echo "  3) ะัะผะตะฝะฐ"
    echo ""
    read -p "ะะฐั ะฒัะฑะพั (1/2/3): " choice

    case $choice in
        1)
            echo "ะะพะดะบะปััะฐะตะผัั ะบ ัะตััะธะธ..."
            tmux attach-session -t $SESSION_NAME
            exit 0
            ;;
        2)
            echo "ะฃะดะฐะปัะตะผ ััะฐััั ัะตััะธั..."
            tmux kill-session -t $SESSION_NAME
            ;;
        *)
            echo "ะัะผะตะฝะฐ."
            exit 0
            ;;
    esac
fi

echo "======================================"
echo "ะะฐะฟััะบ ะพะฑััะตะฝะธั ะฒ tmux"
echo "======================================"
echo ""
echo "ะะฐัะฐะผะตััั ะฟะพ ัะผะพะปัะฐะฝะธั:"
echo "  โข ะะพะปะธัะตััะฒะพ ะผะพะดะตะปะตะน: 3"
echo "  โข ะญะฟะพัะธ: 15"
echo "  โข Batch size: 64"
echo "  โข d_model: 128"
echo ""
echo "ะะฐะฟััะบะฐะตะผ ะพะฑััะตะฝะธะต..."
echo ""

# ะกะพะทะดะฐะตะผ ะฝะพะฒัั tmux ัะตััะธั
tmux new-session -d -s $SESSION_NAME -n "training"

# ะะตัะตัะพะดะธะผ ะฒ ะดะธัะตะบัะพัะธั ะธ ะทะฐะฟััะบะฐะตะผ ะพะฑััะตะฝะธะต
tmux send-keys -t $SESSION_NAME "cd $(pwd)" C-m
tmux send-keys -t $SESSION_NAME "echo '===================================='" C-m
tmux send-keys -t $SESSION_NAME "echo 'ะะะฃะงะะะะ MAMBA-2 ะะะะะะะ'" C-m
tmux send-keys -t $SESSION_NAME "echo '===================================='" C-m
tmux send-keys -t $SESSION_NAME "echo ''" C-m
tmux send-keys -t $SESSION_NAME "echo 'ะกะตััะธั: $SESSION_NAME'" C-m
tmux send-keys -t $SESSION_NAME "echo 'ะัะตะผั ััะฐััะฐ: \$(date)'" C-m
tmux send-keys -t $SESSION_NAME "echo ''" C-m
tmux send-keys -t $SESSION_NAME "python3 train.py --data ../datasets/train.parquet 2>&1 | tee training.log" C-m

echo "โ ะะฑััะตะฝะธะต ะทะฐะฟััะตะฝะพ ะฒ tmux ัะตััะธะธ '$SESSION_NAME'"
echo ""
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "๐ ะะฐะบ ัะฐะฑะพัะฐัั ั tmux:"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""
echo "1. ๐ ะะพะดะบะปััะธัััั ะบ ัะตััะธะธ (ัะผะพััะตัั ะฟัะพะณัะตัั):"
echo "   tmux attach-session -t $SESSION_NAME"
echo ""
echo "2. ๐ช ะัะนัะธ ะธะท ัะตััะธะธ (ะพะฑััะตะฝะธะต ะฟัะพะดะพะปะถะธััั):"
echo "   ะะฐะถะผะธัะต: Ctrl+B, ะทะฐัะตะผ D"
echo ""
echo "3. ๐ ะะพัะผะพััะตัั ะปะพะณะธ ะฑะตะท ะฟะพะดะบะปััะตะฝะธั:"
echo "   tail -f training.log"
echo ""
echo "4. ๐ ะกะฟะธัะพะบ ะฒัะตั tmux ัะตััะธะน:"
echo "   tmux ls"
echo ""
echo "5. โน๏ธ  ะััะฐะฝะพะฒะธัั ะพะฑััะตะฝะธะต:"
echo "   tmux kill-session -t $SESSION_NAME"
echo ""
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""
echo "๐ก ะกะพะฒะตั: ะะพะถะตัะต ะทะฐะบัััั ัะตัะผะธะฝะฐะป - ะพะฑััะตะฝะธะต ะฟัะพะดะพะปะถะธััั!"
echo ""
echo "ะะพะดะบะปััะฐััั ะบ ัะตััะธะธ ัะตัะตะท 3 ัะตะบัะฝะดั..."
sleep 3

# ะะพะดะบะปััะฐะตะผัั ะบ ัะตััะธะธ
tmux attach-session -t $SESSION_NAME
