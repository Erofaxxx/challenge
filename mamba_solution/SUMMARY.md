# –°–≤–æ–¥–∫–∞ —Ä–µ—à–µ–Ω–∏—è Mamba-2

## ‚úÖ –ß—Ç–æ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ

### 1. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ Mamba-2
- ‚úÖ Selective State Space Model (SSM)
- ‚úÖ 4 —Å–ª–æ—è Mamba-2 –±–ª–æ–∫–æ–≤
- ‚úÖ Convolutional layers –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
- ‚úÖ Gating mechanisms
- ‚úÖ Residual connections + Layer Normalization

### 2. Feature Engineering
- ‚úÖ Raw features (–±–∞–∑–æ–≤—ã–µ –ø—Ä–∏–∑–Ω–∞–∫–∏)
- ‚úÖ Delta (–ø–µ—Ä–≤–∞—è —Ä–∞–∑–Ω–æ—Å—Ç—å)
- ‚úÖ Acceleration (–≤—Ç–æ—Ä–∞—è —Ä–∞–∑–Ω–æ—Å—Ç—å)
- ‚úÖ Moving Averages (–æ–∫–Ω–∞: 3, 5, 10, 20)
- ‚úÖ Standard Deviations (–æ–∫–Ω–∞: 5, 10, 20)
- ‚úÖ Exponential Moving Averages (decay: 0.1, 0.3, 0.5)
- ‚úÖ **–ò—Ç–æ–≥–æ: 13x —É–≤–µ–ª–∏—á–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–Ω–æ—Å—Ç–∏**

### 3. Per-Sequence –æ–±—Ä–∞–±–æ—Ç–∫–∞
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π —Å–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø—Ä–∏ —Å–º–µ–Ω–µ seq_ix
- ‚úÖ Per-sequence –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è (–Ω–µ –≥–ª–æ–±–∞–ª—å–Ω–∞—è!)
- ‚úÖ Running statistics (Welford's method)
- ‚úÖ –°–±—Ä–æ—Å feature engineer –ø—Ä–∏ –Ω–æ–≤–æ–π –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### 4. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è
- ‚úÖ CPU-only —Ä–µ–∂–∏–º
- ‚úÖ –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏
- ‚úÖ d_model = 128 (–∫–æ–º–ø–∞–∫—Ç–Ω–∞—è –º–æ–¥–µ–ª—å)
- ‚úÖ context_length = 80 —à–∞–≥–æ–≤
- ‚úÖ Batch size = 64
- ‚úÖ Early stopping (patience=5)
- ‚úÖ Cosine Annealing Warm Restarts

### 5. –ê–Ω—Å–∞–º–±–ª—å
- ‚úÖ 3 –º–æ–¥–µ–ª–∏ —Å —Ä–∞–∑–Ω—ã–º–∏ random seeds
- ‚úÖ –£—Å—Ä–µ–¥–Ω–µ–Ω–∏–µ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π

## üìÅ –°–æ–∑–¥–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

```
mamba_solution/
‚îú‚îÄ‚îÄ solution.py              # –ì–ª–∞–≤–Ω—ã–π —Ñ–∞–π–ª (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–´–ô)
‚îÇ                            # - PredictionModel class
‚îÇ                            # - Mamba2Model architecture
‚îÇ                            # - FeatureEngineer
‚îÇ                            # - SequenceNormalizer
‚îÇ
‚îú‚îÄ‚îÄ train.py                 # –°–∫—Ä–∏–ø—Ç –æ–±—É—á–µ–Ω–∏—è
‚îÇ                            # - –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–µ–π
‚îÇ                            # - Per-sequence feature engineering
‚îÇ                            # - –°–æ–∑–¥–∞–Ω–∏–µ datasets
‚îÇ                            # - –û–±—É—á–µ–Ω–∏–µ –∞–Ω—Å–∞–º–±–ª—è
‚îÇ
‚îú‚îÄ‚îÄ requirements.txt         # –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
‚îÇ                            # - torch, numpy, pandas
‚îÇ                            # - scikit-learn, tqdm, pyarrow
‚îÇ
‚îú‚îÄ‚îÄ README.md               # –ü–æ–¥—Ä–æ–±–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è (English)
‚îÇ
‚îú‚îÄ‚îÄ –ò–ù–°–¢–†–£–ö–¶–ò–Ø.md           # –ü–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è (–†—É—Å—Å–∫–∏–π)
‚îÇ                            # - –ü–æ—à–∞–≥–æ–≤–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ
‚îÇ                            # - –†–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º
‚îÇ                            # - FAQ
‚îÇ
‚îú‚îÄ‚îÄ prepare_submission.sh   # –°–∫—Ä–∏–ø—Ç —Å–æ–∑–¥–∞–Ω–∏—è submission.zip
‚îÇ
‚îî‚îÄ‚îÄ SUMMARY.md              # –≠—Ç–æ—Ç —Ñ–∞–π–ª - –∫—Ä–∞—Ç–∫–∞—è —Å–≤–æ–¥–∫–∞
```

## üéØ –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –º–æ–¥–µ–ª–∏

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ó–Ω–∞—á–µ–Ω–∏–µ | –û–ø–∏—Å–∞–Ω–∏–µ |
|----------|----------|----------|
| d_model | 128 | –†–∞–∑–º–µ—Ä–Ω–æ—Å—Ç—å –º–æ–¥–µ–ª–∏ |
| n_layers | 4 | –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ Mamba —Å–ª–æ–µ–≤ |
| d_state | 16 | –†–∞–∑–º–µ—Ä–Ω–æ—Å—Ç—å SSM —Å–æ—Å—Ç–æ—è–Ω–∏—è |
| context_length | 80 | –ö–æ–Ω—Ç–µ–∫—Å—Ç –≤ —à–∞–≥–∞—Ö |
| batch_size | 64 | –†–∞–∑–º–µ—Ä –±–∞—Ç—á–∞ |
| epochs | 15 | –ú–∞–∫—Å–∏–º—É–º —ç–ø–æ—Ö |
| learning_rate | 0.0005 | –ù–∞—á–∞–ª—å–Ω—ã–π LR |
| num_models | 3 | –ú–æ–¥–µ–ª–µ–π –≤ –∞–Ω—Å–∞–º–±–ª–µ |

## üìä –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

- **Baseline (Moving Average)**: R¬≤ ‚âà 0.15-0.20
- **LSTM**: R¬≤ ‚âà 0.25-0.35
- **Mamba-2 (–Ω–∞—à–µ —Ä–µ—à–µ–Ω–∏–µ)**: R¬≤ ‚âà **0.39-0.45**

## üöÄ –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å

### 1. –ü–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
–°–∫–∞—á–∞–π—Ç–µ `train.parquet` —Å https://wundernn.io/ –∏ –ø–æ–º–µ—Å—Ç–∏—Ç–µ –≤ `../datasets/`

### 2. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
```bash
cd mamba_solution
pip install -r requirements.txt
```

### 3. –û–±—É—á–∏—Ç—å –º–æ–¥–µ–ª–∏
```bash
python train.py --data ../datasets/train.parquet
```

### 4. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å
```bash
python solution.py
```

### 5. –°–æ–∑–¥–∞—Ç—å submission
```bash
./prepare_submission.sh
```

## ‚ö° –ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

### 1. –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–µ–π
```python
if self.current_seq_ix != data_point.seq_ix:
    self._reset_sequence()  # –ü–æ–ª–Ω—ã–π —Å–±—Ä–æ—Å!
```

### 2. Per-Sequence –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è
```python
# –î–ª—è –ö–ê–ñ–î–û–ô –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –æ—Ç–¥–µ–ª—å–Ω–æ!
normalizer = SequenceNormalizer(engineered_dim)
for step in sequence:
    normalized = normalizer.update_and_normalize(features)
```

### 3. Feature Engineering
```python
# 13x —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ –ø—Ä–∏–∑–Ω–∞–∫–æ–≤
engineered_features = [
    raw,           # 1x
    delta,         # 1x
    accel,         # 1x
    MA_windows,    # 4x
    std_windows,   # 3x
    EMA_decays     # 3x
]
```

### 4. Mamba-2 SSM
```python
# Simplified Selective State Space Model
A = -exp(A_log)
state_proj = x_proj(x)
ssm_out = matmul(state_proj, A.T)
y = ssm_out + D * x  # Skip connection
```

## üèÜ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ —Ä–µ—à–µ–Ω–∏—è

1. **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ Mamba-2**
   - –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–µ–µ LSTM/GRU –¥–ª—è –¥–ª–∏–Ω–Ω—ã—Ö –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–µ–π
   - –õ–∏–Ω–µ–π–Ω–∞—è —Å–ª–æ–∂–Ω–æ—Å—Ç—å (vs –∫–≤–∞–¥—Ä–∞—Ç–∏—á–Ω–∞—è —É Transformer)
   - Selective SSM –∞–¥–∞–ø—Ç–∏—Ä—É–µ—Ç—Å—è –∫ –¥–∞–Ω–Ω—ã–º

2. **Feature Engineering**
   - 13x –±–æ–ª—å—à–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
   - –†–∞–∑–ª–∏—á–Ω—ã–µ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –º–∞—Å—à—Ç–∞–±—ã (3-50 —à–∞–≥–æ–≤)
   - –¢—Ä–µ–Ω–¥—ã –∏ –≤–∞—Ä–∏–∞—Ç–∏–≤–Ω–æ—Å—Ç—å

3. **Per-Sequence –æ–±—Ä–∞–±–æ—Ç–∫–∞**
   - –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –∏–∑–æ–ª—è—Ü–∏—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–µ–π
   - –ù–µ—Ç —É—Ç–µ—á–∫–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –º–µ–∂–¥—É seq_ix
   - –ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è

4. **–ê–Ω—Å–∞–º–±–ª—å**
   - –°–Ω–∏–∂–∞–µ—Ç variance
   - –ë–æ–ª–µ–µ —Å—Ç–∞–±–∏–ª—å–Ω—ã–µ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è
   - –†–æ–±–∞—Å—Ç–Ω–æ—Å—Ç—å –∫ –≤—ã–±—Ä–æ—Å–∞–º

5. **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è**
   - –†–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ CPU
   - –£–º–µ—â–∞–µ—Ç—Å—è –≤ 16GB RAM
   - –ë—ã—Å—Ç—Ä—ã–π –∏–Ω—Ñ–µ—Ä–µ–Ω—Å

## üìù –í–∞–∂–Ω—ã–µ –¥–µ—Ç–∞–ª–∏

### Warm-up –ø–µ—Ä–∏–æ–¥
- –®–∞–≥–∏ 0-99: –Ω–∞–∫–∞–ø–ª–∏–≤–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç (need_prediction=False)
- –®–∞–≥–∏ 100-999: –¥–µ–ª–∞–µ–º –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è (need_prediction=True)
- **900 scored predictions –Ω–∞ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å**

### –û–±—É—á–∞—é—â–∏–µ –ø—Ä–∏–º–µ—Ä—ã
- i=99: –∫–æ–Ω—Ç–µ–∫—Å—Ç [0...99] ‚Üí –ø—Ä–µ–¥—Å–∫–∞–∑—ã–≤–∞–µ–º —à–∞–≥ 100
- i=100: –∫–æ–Ω—Ç–µ–∫—Å—Ç [21...100] ‚Üí –ø—Ä–µ–¥—Å–∫–∞–∑—ã–≤–∞–µ–º —à–∞–≥ 101
- i=998: –∫–æ–Ω—Ç–µ–∫—Å—Ç [919...998] ‚Üí –ø—Ä–µ–¥—Å–∫–∞–∑—ã–≤–∞–µ–º —à–∞–≥ 999

### Memory management
- –°–±—Ä–æ—Å –ø—Ä–∏ —Å–º–µ–Ω–µ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- gc.collect() –∫–∞–∂–¥—ã–µ 5 —ç–ø–æ—Ö
- deque —Å maxlen –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏

## üéì –ß—Ç–æ –¥–∞–ª—å—à–µ

### –î–ª—è –∑–∞–ø—É—Å–∫–∞ –æ–±—É—á–µ–Ω–∏—è:
```bash
# –ë–∞–∑–æ–≤–æ–µ –æ–±—É—á–µ–Ω–∏–µ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
python train.py --data ../datasets/train.parquet

# –ë—ã—Å—Ç—Ä–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
python train.py --data ../datasets/train.parquet --num-models 1 --epochs 5
```

### –î–ª—è —É–ª—É—á—à–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤:
1. –£–≤–µ–ª–∏—á—å—Ç–µ –∞–Ω—Å–∞–º–±–ª—å: `--num-models 5`
2. –ë–æ–ª—å—à–µ —ç–ø–æ—Ö: `--epochs 20`
3. –ë–æ–ª—å—à–∞—è –º–æ–¥–µ–ª—å: `--d-model 192 --n-layers 6`
4. –ë–æ–ª—å—à–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç: `--context-length 100`

### –î–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ —Ä–µ—Å—É—Ä—Å–æ–≤:
1. –ú–µ–Ω—å—à–µ –º–æ–¥–µ–ª–µ–π: `--num-models 1`
2. –ú–µ–Ω—å—à–µ —ç–ø–æ—Ö: `--epochs 10`
3. –ú–µ–Ω—å—à–∏–π batch: `--batch-size 32`
4. –ö–æ–º–ø–∞–∫—Ç–Ω–∞—è –º–æ–¥–µ–ª—å: `--d-model 96`

## ‚úÖ –ß–µ–∫-–ª–∏—Å—Ç –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏

- [x] –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ Mamba-2 —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞
- [x] Feature engineering —Ä–∞–±–æ—Ç–∞–µ—Ç
- [x] Per-sequence –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è
- [x] –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π —Å–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è
- [x] –ê–Ω—Å–∞–º–±–ª—å –∏–∑ 3 –º–æ–¥–µ–ª–µ–π
- [x] CPU-only —Ä–µ–∂–∏–º
- [x] –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ –ø–æ–¥ —Ä–µ—Å—É—Ä—Å—ã
- [x] –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –Ω–∞ —Ä—É—Å—Å–∫–æ–º
- [x] –°–∫—Ä–∏–ø—Ç –æ–±—É—á–µ–Ω–∏—è
- [x] –°–∫—Ä–∏–ø—Ç submission
- [ ] **–ù—É–∂–Ω–æ –æ–±—É—á–∏—Ç—å –º–æ–¥–µ–ª–∏!**
- [ ] **–ù—É–∂–Ω–æ —Å–∫–∞—á–∞—Ç—å –¥–∞–Ω–Ω—ã–µ!**

## üìû –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. **–°–∫–∞—á–∞–π—Ç–µ –¥–∞–Ω–Ω—ã–µ** —Å https://wundernn.io/
2. **–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏**: `pip install -r requirements.txt`
3. **–û–±—É—á–∏—Ç–µ –º–æ–¥–µ–ª–∏**: `python train.py --data ../datasets/train.parquet`
4. **–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ**: `python solution.py`
5. **–°–æ–∑–¥–∞–π—Ç–µ submission**: `./prepare_submission.sh`
6. **–û—Ç–ø—Ä–∞–≤—å—Ç–µ** –Ω–∞ —Å–∞–π—Ç —Å–æ—Ä–µ–≤–Ω–æ–≤–∞–Ω–∏—è

## üèÅ –£–¥–∞—á–∏!

–†–µ—à–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ –∫ –æ–±—É—á–µ–Ω–∏—é –∏ –æ—Ç–ø—Ä–∞–≤–∫–µ. –°–ª–µ–¥—É–π—Ç–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º –≤ `–ò–ù–°–¢–†–£–ö–¶–ò–Ø.md` –¥–ª—è –ø–æ—à–∞–≥–æ–≤–æ–≥–æ –∑–∞–ø—É—Å–∫–∞.

**–¶–µ–ª–µ–≤–æ–π R¬≤ score: ‚â• 0.39**

–£—Å–ø–µ—Ö–æ–≤ –≤ —Å–æ—Ä–µ–≤–Ω–æ–≤–∞–Ω–∏–∏! üöÄ
